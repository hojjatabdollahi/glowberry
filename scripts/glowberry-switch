#!/bin/bash
#
# glowberry-switch - Helper script to switch between GlowBerry and official cosmic-bg
#
# This works by creating a symlink at /usr/local/bin/cosmic-bg that points to glowberry.
# Since /usr/local/bin is searched before /usr/bin, cosmic-session will run glowberry
# instead of the original cosmic-bg when enabled.
#
# Usage: glowberry-switch {enable|disable|status}
#

set -e

GLOWBERRY_BIN="/usr/bin/glowberry"
SYMLINK_PATH="/usr/local/bin/cosmic-bg"
ORIGINAL_COSMIC_BG="/usr/bin/cosmic-bg"

usage() {
    cat <<EOF
Usage: glowberry-switch <command>

Commands:
    enable                Enable GlowBerry as the background service (creates symlink)
    disable               Disable GlowBerry and restore original cosmic-bg
    status                Show current status
    help                  Show this help message

How it works:
    GlowBerry intercepts cosmic-session's call to cosmic-bg by placing a symlink
    at /usr/local/bin/cosmic-bg that points to /usr/bin/glowberry. Since
    /usr/local/bin is searched before /usr/bin in PATH, cosmic-session will
    run GlowBerry instead of the original cosmic-bg.

Examples:
    glowberry-switch enable     # Enable GlowBerry
    glowberry-switch disable    # Switch back to original cosmic-bg
    glowberry-switch status     # Check current status
EOF
}

# Check if /usr/local/bin comes before /usr/bin in PATH
# Returns 0 if PATH is correct, 1 if not
check_path_order() {
    # Get positions of /usr/local/bin and /usr/bin in PATH
    local path_array
    IFS=':' read -ra path_array <<< "$PATH"
    
    local local_bin_pos=-1
    local usr_bin_pos=-1
    local i=0
    
    for p in "${path_array[@]}"; do
        if [ "$p" = "/usr/local/bin" ]; then
            local_bin_pos=$i
        elif [ "$p" = "/usr/bin" ]; then
            usr_bin_pos=$i
        fi
        ((i++))
    done
    
    if [ $local_bin_pos -eq -1 ]; then
        return 2  # /usr/local/bin not in PATH at all
    elif [ $usr_bin_pos -eq -1 ]; then
        return 0  # /usr/bin not in PATH, so /usr/local/bin wins by default
    elif [ $local_bin_pos -lt $usr_bin_pos ]; then
        return 0  # /usr/local/bin comes first - correct
    else
        return 1  # /usr/bin comes first - wrong order
    fi
}

warn_path_order() {
    check_path_order
    local result=$?
    
    if [ $result -eq 1 ]; then
        echo ""
        echo "WARNING: /usr/bin appears before /usr/local/bin in your PATH!"
        echo "         GlowBerry override may not work correctly."
        echo ""
        echo "Your PATH order:"
        echo "$PATH" | tr ':' '\n' | grep -n "bin" | head -10
        echo ""
        echo "To fix this, ensure /usr/local/bin comes before /usr/bin in your PATH."
        echo "You may need to edit ~/.bashrc, ~/.profile, or /etc/environment"
        echo ""
    elif [ $result -eq 2 ]; then
        echo ""
        echo "WARNING: /usr/local/bin is not in your PATH!"
        echo "         GlowBerry override will not work."
        echo ""
        echo "Add /usr/local/bin to your PATH by editing ~/.bashrc or ~/.profile:"
        echo "  export PATH=\"/usr/local/bin:\$PATH\""
        echo ""
    fi
}

enable_glowberry() {
    if ! [ -f "$GLOWBERRY_BIN" ]; then
        echo "Error: GlowBerry not found at $GLOWBERRY_BIN"
        echo "Please install GlowBerry first with: just install"
        exit 1
    fi

    # Check PATH order and warn if incorrect
    warn_path_order

    # Create the symlink (requires sudo)
    echo "Creating symlink at $SYMLINK_PATH -> $GLOWBERRY_BIN"
    sudo ln -sf "$GLOWBERRY_BIN" "$SYMLINK_PATH"

    # Kill any running cosmic-bg/glowberry processes so the new one starts
    echo "Restarting background service..."
    pkill -x cosmic-bg 2>/dev/null || true
    pkill -x glowberry 2>/dev/null || true

    echo ""
    echo "GlowBerry is now enabled!"
    echo "The background service will restart automatically, or you can log out and back in."
}

disable_glowberry() {
    if [ -L "$SYMLINK_PATH" ]; then
        echo "Removing symlink at $SYMLINK_PATH"
        sudo rm "$SYMLINK_PATH"
    else
        echo "No symlink found at $SYMLINK_PATH"
    fi

    # Kill any running processes so the original cosmic-bg can start
    echo "Restarting background service..."
    pkill -x cosmic-bg 2>/dev/null || true
    pkill -x glowberry 2>/dev/null || true

    echo ""
    echo "GlowBerry disabled. Original cosmic-bg is now active."
    echo "The background service will restart automatically, or you can log out and back in."
}

show_status() {
    echo "GlowBerry Status"
    echo "================"
    echo ""

    # Check PATH order
    check_path_order
    local path_result=$?
    if [ $path_result -eq 0 ]; then
        echo "PATH order: OK (/usr/local/bin before /usr/bin)"
    elif [ $path_result -eq 1 ]; then
        echo "PATH order: WARNING - /usr/bin comes before /usr/local/bin!"
    else
        echo "PATH order: WARNING - /usr/local/bin not in PATH!"
    fi
    echo ""

    # Check if GlowBerry is installed
    if [ -f "$GLOWBERRY_BIN" ]; then
        echo "GlowBerry binary: installed at $GLOWBERRY_BIN"
    else
        echo "GlowBerry binary: NOT INSTALLED"
    fi

    # Check if original cosmic-bg exists
    if [ -f "$ORIGINAL_COSMIC_BG" ]; then
        echo "Original cosmic-bg: installed at $ORIGINAL_COSMIC_BG"
    else
        echo "Original cosmic-bg: not found"
    fi

    echo ""

    # Check symlink status
    if [ -L "$SYMLINK_PATH" ]; then
        TARGET=$(readlink -f "$SYMLINK_PATH")
        echo "Symlink: $SYMLINK_PATH -> $TARGET"
        if [ "$TARGET" = "$GLOWBERRY_BIN" ]; then
            echo "Status: GlowBerry is ENABLED (will run instead of cosmic-bg)"
        else
            echo "Status: Symlink points elsewhere"
        fi
    else
        echo "Symlink: not present"
        echo "Status: Original cosmic-bg is active"
    fi

    echo ""

    # Check which binary would actually run
    WHICH_COSMIC_BG=$(which cosmic-bg 2>/dev/null || echo "not found")
    echo "which cosmic-bg: $WHICH_COSMIC_BG"

    # Check running process
    if pgrep -x glowberry >/dev/null 2>&1; then
        echo "Running: glowberry (PID: $(pgrep -x glowberry))"
    elif pgrep -x cosmic-bg >/dev/null 2>&1; then
        echo "Running: cosmic-bg (PID: $(pgrep -x cosmic-bg))"
    else
        echo "Running: no background service detected"
    fi
}

case "${1:-}" in
    enable)
        enable_glowberry
        ;;
    disable)
        disable_glowberry
        ;;
    status)
        show_status
        ;;
    help|--help|-h)
        usage
        ;;
    "")
        usage
        exit 1
        ;;
    *)
        echo "Unknown command: $1"
        echo ""
        usage
        exit 1
        ;;
esac
